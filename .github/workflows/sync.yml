name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 19 * * *" # åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹ (UTC 19:00)
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # Step 1: run a standard checkout action
      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: run the sync action
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: cmliu/edgetunnel
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }} # automatically generated, no need to set

          # Set test_mode true to run tests instead of the true action!!
          test_mode: false

      # Step 3: è‡ªåŠ¨ä¿®æ”¹ wrangler.toml ä¸­çš„ name å’Œ KV é…ç½®
      - name: Customize wrangler.toml
        if: steps.sync.outputs.has_new_commits == 'true'
        run: |
          # æ£€æŸ¥ wrangler.toml æ˜¯å¦å­˜åœ¨
          if [ -f "wrangler.toml" ]; then
            # 1. ä¿®æ”¹ name å­—æ®µ
            sed -i 's/^name = ".*"/name = "mysok"/' wrangler.toml
            echo "âœ… wrangler.toml ä¸­çš„ name å·²ä¿®æ”¹ä¸º mysok"
            
            # 2. å–æ¶ˆæ³¨é‡Šå¹¶é…ç½® KV
            # åˆ é™¤ #[[kv_namespaces]] è¡Œçš„æ³¨é‡Š
            sed -i 's/^#\[\[kv_namespaces\]\]/[[kv_namespaces]]/' wrangler.toml
            # åˆ é™¤ binding è¡Œçš„æ³¨é‡Šå¹¶ä¿æŒåŸå€¼
            sed -i 's/^#binding = "KV"/binding = "KV"/' wrangler.toml
            # åˆ é™¤ id è¡Œçš„æ³¨é‡Šå¹¶å¡«å…¥ KV ID
            sed -i 's/^#id = ""/id = "5419b46bc4b24de4a31b024daa22d653"/' wrangler.toml
            echo "âœ… KV å‘½åç©ºé—´å·²é…ç½®: binding=KV, id=5419b46bc4b24de4a31b024daa22d653"
          else
            echo "âš ï¸ wrangler.toml æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿®æ”¹"
          fi

      # Step 4: æäº¤ä¿®æ”¹
      - name: Commit customization
        if: steps.sync.outputs.has_new_commits == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --quiet wrangler.toml; then
            echo "ğŸ“ wrangler.toml æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git add wrangler.toml
            git commit -m "chore: è‡ªåŠ¨ä¿®æ”¹ wrangler.toml name ä¸º mysok"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€ wrangler.toml çš„ä¿®æ”¹"
          fi

      - name: Sync check
        if: failure()
        run: |
          echo "[Error] ç”±äºä¸Šæ¸¸ä»“åº“çš„ workflow æ–‡ä»¶å˜æ›´ï¼Œå¯¼è‡´ GitHub è‡ªåŠ¨æš‚åœäº†æœ¬æ¬¡è‡ªåŠ¨æ›´æ–°ï¼Œä½ éœ€è¦æ‰‹åŠ¨ Sync Fork ä¸€æ¬¡ï¼Œè¯¦ç»†æ•™ç¨‹è¯·æŸ¥çœ‹é¡¹ç›®README.md "
          echo "[Error] Due to a change in the workflow file of the upstream repository, GitHub has automatically suspended the scheduled automatic update. You need to manually sync your fork. Please refer to the project README.md for instructions. "
          exit 1
